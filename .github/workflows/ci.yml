name: OS-1000-Lines-Zig CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  ZIG_VERSION: "0.15.2"

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Zig
      uses: korandoru/setup-zig@v1
      with:
        zig-version: ${{ env.ZIG_VERSION }}

    - name: Verify Zig installation
      run: zig version

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-system-misc llvm

    - name: Verify QEMU installation
      run: |
        qemu-system-riscv32 --version
        llvm-objdump --version

    - name: Run Zig fmt check
      run: zig fmt --check src/

    - name: Build kernel
      run: zig build

    - name: Verify kernel binary
      run: |
        ls -la zig-out/bin/
        file zig-out/bin/kernel.elf
        llvm-objdump -h zig-out/bin/kernel.elf

  build-matrix:
    name: Build on ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Zig
      uses: korandoru/setup-zig@v1
      with:
        zig-version: ${{ env.ZIG_VERSION }}

    - name: Install dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-system-misc llvm

    - name: Install dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install qemu llvm
        echo "$(brew --prefix llvm)/bin" >> $GITHUB_PATH

    - name: Verify llvm-objcopy (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        which llvm-objcopy
        llvm-objcopy --version

    - name: Build kernel
      run: zig build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-${{ matrix.os }}
        path: zig-out/bin/

  qemu-test:
    name: QEMU Boot Test
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Zig
      uses: korandoru/setup-zig@v1
      with:
        zig-version: ${{ env.ZIG_VERSION }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-system-misc llvm

    - name: Build kernel
      run: zig build

    - name: Test kernel boot in QEMU
      run: |
        timeout 10s qemu-system-riscv32 \
          -machine virt \
          -bios default \
          -nographic \
          -serial mon:stdio \
          --no-reboot \
          -kernel zig-out/bin/kernel.elf || true
        echo "âœ“ QEMU boot test completed"

  code-analysis:
    name: Code Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Zig
      uses: korandoru/setup-zig@v1
      with:
        zig-version: ${{ env.ZIG_VERSION }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-system-misc llvm cloc

    - name: Build kernel
      run: zig build

    - name: Generate code statistics
      run: |
        echo "## Code Statistics" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        cloc src/ --exclude-dir=.zig-cache >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    - name: Analyze binary size
      run: |
        echo "## Binary Analysis" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "Kernel binary size:" >> $GITHUB_STEP_SUMMARY
        ls -lh zig-out/bin/kernel.elf >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Section sizes:" >> $GITHUB_STEP_SUMMARY
        llvm-objdump -h zig-out/bin/kernel.elf >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    - name: Memory layout analysis
      run: |
        echo "## Memory Layout" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        llvm-nm --size-sort zig-out/bin/kernel.elf | head -20 >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  release:
    name: Create Release
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    needs: [test, build-matrix, qemu-test]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Zig
      uses: korandoru/setup-zig@v1
      with:
        zig-version: ${{ env.ZIG_VERSION }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-system-misc llvm

    - name: Build release kernel
      run: zig build -Drelease

    - name: Create release package
      run: |
        mkdir -p release
        cp zig-out/bin/kernel.elf release/
        cp zig-out/bin/user.elf release/
        cp README.md release/
        cp ROADMAP.md release/
        tar -czf os-1000-lines-zig-latest.tar.gz -C release .

    - name: Upload release artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-package
        path: os-1000-lines-zig-latest.tar.gz